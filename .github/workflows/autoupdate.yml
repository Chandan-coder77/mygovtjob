name: Auto Update Jobs

on:
  schedule:
    - cron: "0 */6 * * *"   # Har 6 ghante auto run
  workflow_dispatch:        # Manual run

jobs:
  scrape_and_train:
    runs-on: ubuntu-latest

    # ===============================
    # ðŸ”¥ Apache Tika Service (PDF Engine)
    # ===============================
    services:
      tika:
        image: apache/tika:2.9.0
        ports:
          - 9998:9998

    steps:
      # ===============================
      # Step-0: Pull Repository
      # ===============================
      - name: Pull Repository
        uses: actions/checkout@v3

      # ===============================
      # Step-1: Python Setup
      # ===============================
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      # ===============================
      # Step-2: Install Dependencies
      # ===============================
      - name: Install Dependencies
        run: |
          pip install requests beautifulsoup4 pdfminer.six lxml

      # ===============================
      # Step-3: Raw Scraper (A5.1)
      # ===============================
      - name: Run Scraper (Source Collector)
        run: python scraper_detail.py

      # ===============================
      # Step-4: Job Intelligence Filter (A5.2)
      # ===============================
      - name: Run Job Intelligence Filter (A5.2)
        run: python job_intelligence_filter.py

      # ===============================
      # Step-5: Autopilot Master (A4 + A5.2.2)
      # ===============================
      - name: Run Autopilot Master
        run: python autopilot_master.py

      # ===============================
      # Step-5.5: Job Sanity Corrector (A5.3)
      # ===============================
      - name: Run Job Sanity Corrector
        run: python job_sanity_corrector.py

      # ===============================
      # Step-5.7: Job Detail Extractor (A5.4.1)
      # ===============================
      - name: Run Job Detail Extractor
        run: python job_detail_extractor.py

      # ===============================
      # Step-5.8: Job Field Sanity v2 (A5.4.3)
      # ===============================
      - name: Run Job Field Sanity v2
        run: python job_field_sanity_v2.py

      # ===============================
      # Step-5.9: Global Deduplicator (A5.5)
      # ===============================
      - name: Run Global Job Deduplicator
        run: python job_global_deduplicator.py

      # ===============================
      # Step-6.1: Job Validity Gate (A6.1)
      # ===============================
      - name: Run Job Validity Gate
        run: python job_validity_gate.py

      # =====================================================
      # ðŸ”¥ Step-6.9: MASTER JOB ENGINE (Accuracy Booster)
      # Uses:
      # - Apache Tika (PDF)
      # - HuggingFace APIs (NER, Translation, Classification)
      # =====================================================
      - name: Run Master Job Engine (Accuracy Booster)
        env:
          HF_API_KEY: ${{ secrets.HF_API_KEY }}
        run: python master_job_engine.py

      # ===============================
      # Step-6.2: AI Trainer
      # ===============================
      - name: Train AI Memory
        run: python ai_trainer.py

      # ===============================
      # Step-7: AI Corrector Deep Engine
      # ===============================
      - name: AI Corrector Smart Update
        run: python ai_corrector_v2.py

      # ===============================
      # Step-8: Clean & Compress AI Memory
      # ===============================
      - name: Clean & Compress AI Memory
        run: python clean_memory.py

      # ===============================
      # Step-9: Auto Backup
      # ===============================
      - name: Auto Backup before commit
        run: |
          mkdir -p backup
          cp ai_memory.json backup/ai_memory_$(date +'%d-%m-%Y_%H-%M-%S').json || echo "Backup skipped"

      # ===============================
      # Step-10: Commit & Push (SAFE)
      # ===============================
      - name: Commit & Push Results
        run: |
          git config --global user.name "GitHub AI Bot"
          git config --global user.email "actions@github.com"
          git add -A
          git commit -m "Auto Update Jobs + Master Engine Accuracy Boost ðŸ¤–" || echo "No changes"
          git push --force
